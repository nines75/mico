# コメントフィルター

## フィルター構文

### 用語

- ディレクティブ: 特別な動作を指示するための命令(例:`@strict`,`@include`)
- 空白文字: 正規表現で`\s`に一致する文字(半角/全角スペースなど)

### コメント

`#`以降の文字列はコメントと解釈されます。  
`#`の直前が1文字以上の空白文字だった場合、その空白文字の集合はルールの一部とは解釈されません。

### エスケープ

構文として解釈される文字列の前にエスケープ記号(`\`)を付けることでエスケープできます。

行頭のエスケープ記号はそれがエスケープ用として使われているかに関わらず削除されます。  
削除される記号は赤くハイライトされます。  
これはディレクティブが利用可能なフィルターでのみ行われます。

### ルールの終了(`@end`)

直近に書いたディレクティブの適用を終了させます。  
書かなかった場合は宣言した場所からフィルターの終端までが適用範囲になります。

#### 例

```
@strict
rule1 # strictルール
@end

rule2 # 特殊ルールなし

@strict
rule3 # strictルール
```

### strictルール(`@strict`/`!`)

strictルールとは、フィルタリングされたコメントの投稿者のユーザーIDを自動でフィルターの先頭に追加するルールです。

このルールによってフィルタリングされたユーザーIDにはログで`[!]`という記号が表示されます。

フィルターは基本的に昇順に評価されますが、strictルールはかんたんコメントの一括非表示を除いた全てのフィルターに先行して評価されます。  
これはルールを書いた順番によってフィルタリング結果が変わらないようにするためです。

#### `@strict`

以降のフィルタリングルールをstrictルールにします。

#### `!`

行頭に書くことで一行だけstrictルールにすることができます。

#### 例

```
@strict
rule1 # strictルール
@end

!rule2 # strictルール
```

### tagルール(`@include`/`@exclude`)

tagルールとは、動画タグに基づいてフィルタリングルールの適用/除外ができるルールです。

#### `@include`

指定したパターンにマッチする動画タグがある場合、以降のフィルタリングルールを**有効化**します。

#### `@exclude`

指定したパターンにマッチする動画タグがある場合、以降のフィルタリングルールを**無効化**します。

#### パターンの指定方法

`@include`または`@exclude`のあとに、**半角スペース**区切りで何個でも指定できます。  
複数個指定した場合、OR条件として判定されます(いずれかのパターンに一致したら適用/除外)。

> [!WARNING]
> 全角スペースは文字と解釈されるため注意してください。

パターンはタグとパターンの両方を小文字に変換してから比較されます。

このディレクティブはネストさせることができます。  
その際、`@include`と`@exclude`が競合した場合は`@exclude`が優先されます。

#### 例

```
@include tag1 TAG2
rule1 # tag1,TAG1,tAg1,tag2などが動画タグに存在した場合に有効化。tag10などでは有効化されない

# ネストされたtagルール
@exclude tag3
rule2 # rule1と同様だが、tag3などが動画タグに存在した場合は無効化

# 誤った書き方(□を全角スペースとする)
@include□tag # ディレクティブと解釈されない('@include□tag'というルールと解釈される)
@include tag1□tag2 # 'tag1□tag2'などが動画タグに存在した場合に有効化される
```

### 無効化ルール(`@disable`)

無効化ルールとは、コメントのコマンドを無効化できるルールです。

このルールによるフィルタリングではログは保存されません。  
ポップアップに無効化したコマンドの数が表示されますが、これは無効化後に非表示にされたコメントのコマンドの数も含まれます。

NGコマンド内ではstrictルールも使用可能ですが、無効化ルールと重複した場合はstrictルールは適用されません。

#### `@disable`

以降のフィルタリングルールを無効化ルールにします。

#### `all`

無効化ルールとして書くことで全てのコマンドを無効化できます。  
単なるNGコマンドとして登録しても同様の効果はありません。

#### 例

```
@disable
red # 'red'というコマンドを無効化
all # すべてのコマンドを無効化
@end

all # 'all'というコマンドを含むコメントを非表示
```

### 動画限定ルール

動画限定ルールとは、特定の動画IDのみ適用されるルールです。

`動画ID@ルール`という形式で動画IDを指定します。  
基本的にはドロップダウンからNG登録する際に自動で指定することを想定しています。

#### 例

```
sm1234@example-user-id # 動画IDがsm1234である場合のみ、example-user-idというユーザーIDをフィルタリング
```

### 各フィルターで使用できる構文

|                       |   NGユーザーID   |      NGコマンド      | NGワード |
| :-------------------: | :--------------: | :------------------: | :------: |
|       正規表現        | ❌<br>(完全一致) | ❌<br>(小文字に変換) |    ✅    |
|     コメント(`#`)     |        ✅        |          ✅          |    ✅    |
|        `@end`         |        ❌        |          ✅          |    ✅    |
|     `@strict`/`!`     |        ❌        |          ✅          |    ✅    |
| `@include`/`@exclude` |        ❌        |          ✅          |    ✅    |
|      `@disable`       |        ❌        |          ✅          |    ❌    |
|    動画限定ルール     |        ✅        |          ❌          |    ❌    |

## 公式NG機能との競合

この拡張機能は公式NG機能が非表示処理を行う前の段階で動作するため、公式NG機能で何かしらのNG登録をしていても動作に影響はありません。  
ただし異なるルールを登録している場合は追加で非表示処理が行われることがあり、またそれは拡張機能のログに表示されないため予め公式NG機能のルールを空にしておくことをお勧めします。

## 各種ログに表示できるもの

|                            | NGユーザーID |     NGスコア     | NGコマンド | NGワード |
| :------------------------: | :----------: | :--------------: | :--------: | :------: |
|          NGスコア          |      ✅      | ✅<br>(常に表示) |     ✅     |    ❌    |
|           ニコる           |      ✅      |        ✅        |     ✅     |    ❌    |
| 本文が重複したコメントの数 |      ❌      |        ❌        |     ❌     |    ✅    |

# 動画フィルター

## 対応状況

|                                     |                             |
| :---------------------------------: | :-------------------------: |
|             ニコニ広告              |             ❌              |
|        視聴ページ(関連動画)         |             ✅              |
|    視聴ページ(プレイリスト-検索)    |             ✅              |
| 視聴ページ(プレイリスト-マイリスト) |             ❌              |
|  視聴ページ(プレイリスト-シリーズ)  |             ❌              |
|         ランキング(For you)         |             ❌              |
|        ランキング(カテゴリ)         |             ✅              |
|        ランキング(カスタム)         |             ❌              |
|               旧検索                | ✅<br>(動画ID/タイトルのみ) |
|            旧検索(タグ)             |        ✅<br>(同上)         |
|               新検索                |             ✅              |
|            新検索(タグ)             |             ✅              |
