# コメントフィルター

## フィルター構文

### 用語

- 構文指令: `@strict`,`@include`など

### コメント

`#`以降の文字列はコメントと解釈されます。  
`#`の前が1個以上の空白文字だった場合、それはルールとは解釈されません。

### エスケープ

構文として解釈される文字列の前にエスケープ記号(`\`)を付けることでエスケープできます。

行頭にあるエスケープ記号はそれがエスケープ用として使われているかに関わらず削除されます。  
削除される記号は赤くハイライトされます。  
これは構文指令が利用可能なフィルターでのみ行われます。

### ルールの終了(`@end`)

直近に書いた構文指令の適用を終了させます。  
書かなかった場合は宣言した場所から終端までが適用範囲になります。

#### 例

```
@strict
rule1 # strictルール
@end

rule2 # 特殊ルールなし

@strict
rule3 # strictルール
```

### strictルール(`@strict`/`!`)

strictルールとは、フィルタリングされたコメントの投稿者のユーザーIDを自動でフィルターの先頭に追加するルールです。

このルールによってフィルタリングされたユーザーIDにはログで`[!]`という記号が表示されます。

フィルターは基本的に昇順に評価されますが、strictルールはかんたんコメントの一括非表示を除いた全てのフィルターに先行して評価されます。  
これはルールを書いた順番によってフィルタリング結果が変わらないようにするためです。

#### `@strict`

以降のフィルタリングルールをstrictルールにします。

#### `!`

行頭に書くことで一行だけstrictルールにすることができます。

#### 例

```
@strict
rule1 # strictルール
@end

!rule2 # strictルール
```

### tagルール(`@include`/`@exclude`)

tagルールとは、動画タグに基づいてフィルタリングルールの適用/除外ができるルールです。

#### `@include`

指定したパターンにマッチする動画タグがある場合、以降のフィルタリングルールを**有効化**します。

#### `@exclude`

指定したパターンにマッチする動画タグがある場合、以降のフィルタリングルールを**無効化**します。

#### パターンの指定方法

`@include`または`@exclude`のあとに、**半角スペース**1個以上で区切って何回でも指定できます。  
複数個指定した場合、OR条件として判定されます(いずれかのパターンに1つでも一致したら適用/除外)。

> [!WARNING]
> 全角スペースは文字と解釈されるため注意してください。

パターンは完全一致で判定されます。  
この際、タグとパターンの両方を小文字に変換してから判定されます。

この記法はネストさせることができます。  
その際、`@include`と`@exclude`が競合した場合は`@exclude`が優先されます。

#### 例

```
@include tag1 tag2
rule1 # tag1,TAG2などが動画タグに存在した場合に有効化。tag10などでは有効化されない

@exclude tag3
rule2 # rule1と同様だが、tag3が存在した場合は無効化
```

### 無効化ルール(`@disable`)

無効化ルールとは、コメントのコマンドを無効化できるルールです。

このルールによるフィルタリングではログは保存されません。  
ポップアップに無効化したコマンドの数が表示されますが、これは無効化後に非表示されたコメントのコマンドの数も含まれます。

NGコマンド内ではstrictルールも使用可能ですが、無効化ルールと重複した場合はstrictルールは適用されません。

#### `@disable`

以降のフィルタリングルールを無効化ルールにします。

#### `all`

無効化ルールとして書くことで全てのコマンドを無効化できます。  
単なるNGコマンドとして登録しても効果はありません。

#### 例

```
@disable
red # 'red'というコマンドを無効化
all # すべてのコマンドを無効化
@end

all # 'all'というコマンドを無効化
```

### 動画限定ルール

動画限定ルールとは、特定の動画IDのみ適用されるルールです。

`動画ID@ルール`という形式で動画IDを指定します。  
基本的にはコメントをクリックした際に出るドロップダウンから自動で追加することを想定していますが、手動でも指定できます。

#### 例

```
sm1234@example-user-id # 動画IDがsm1234である場合のみ、example-user-idというユーザーIDをフィルタリング
```

### 各フィルターで使用できる構文

|                       |   NGユーザーID   |      NGコマンド      | NGワード |
| :-------------------: | :--------------: | :------------------: | :------: |
|       正規表現        | ❌<br>(完全一致) | ❌<br>(小文字に変換) |    ✅    |
|     コメント(`#`)     |        ✅        |          ✅          |    ✅    |
|        `@end`         |        ❌        |          ✅          |    ✅    |
|     `@strict`/`!`     |        ❌        |          ✅          |    ✅    |
| `@include`/`@exclude` |        ❌        |          ✅          |    ✅    |
|      `@disable`       |        ❌        |          ✅          |    ❌    |
|    動画限定ルール     |        ✅        |          ❌          |    ❌    |

## ログ

### 各種ログに表示できるもの

|                      | NGユーザーID |     NGスコア     | NGコマンド | NGワード |
| :------------------: | :----------: | :--------------: | :--------: | :------: |
|       NGスコア       |      ✅      | ✅<br>(常に表示) |     ✅     |    ❌    |
|        ニコる        |      ✅      |        ✅        |     ✅     |    ❌    |
| 重複したコメントの数 |      ❌      |        ❌        |     ❌     |    ✅    |

# 動画フィルター

## 対応状況

|                          |                             |
| :----------------------: | :-------------------------: |
|        ニコニ広告        |             ❌              |
|   視聴ページ(関連動画)   |             ✅              |
| 視聴ページ(プレイリスト) |             ❌              |
|   ランキング(For you)    |             ❌              |
|   ランキング(カテゴリ)   |             ✅              |
|   ランキング(カスタム)   |             ❌              |
|          旧検索          | ✅<br>(動画ID/タイトルのみ) |
|       旧検索(タグ)       |        ✅<br>(同上)         |
|          新検索          |             ✅              |
|       新検索(タグ)       |             ✅              |
